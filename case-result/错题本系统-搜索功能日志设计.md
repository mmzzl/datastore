# 错题本系统 - 搜索功能日志设计

## 1. 日志系统概述

### 1.1 设计目标
建立一套完整、规范、高效的日志系统，用于记录错题本系统搜索功能的运行状态、用户操作和异常情况，便于问题排查、性能监控和用户行为分析。

### 1.2 日志系统架构
- **日志框架**: Python标准库`logging`模块配合Django日志系统
- **日志级别**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- **日志输出**: 文件日志 + 控制台日志
- **日志格式**: JSON结构化格式

## 2. 日志级别策略

### 2.1 日志级别定义

| 日志级别 | 使用场景 | 示例 |
|---------|---------|------|
| **DEBUG** | 开发调试信息，详细的内部流程记录 | 搜索参数解析、数据库查询SQL语句、详细的执行时间统计 |
| **INFO** | 正常的业务操作记录，用户行为追踪 | 用户搜索请求、搜索历史创建、热门搜索更新等 |
| **WARNING** | 潜在问题或需要关注的异常情况 | 搜索参数缺失、结果为空、非致命错误 |
| **ERROR** | 严重错误，影响功能正常运行 | API调用失败、数据库操作异常、搜索服务不可用 |
| **CRITICAL** | 系统级严重错误，需要立即处理 | 服务崩溃、数据丢失风险、安全漏洞 |

### 2.2 搜索功能日志级别分配

#### 2.2.1 搜索历史模块
- **DEBUG**: 搜索历史查询SQL、过滤条件解析、分页参数计算
- **INFO**: 用户创建搜索历史、查看搜索历史、清除搜索历史
- **WARNING**: 搜索历史查询结果为空、尝试访问他人的搜索历史
- **ERROR**: 搜索历史创建失败、数据库操作异常

#### 2.2.2 搜索建议模块
- **DEBUG**: 搜索建议查询逻辑、频率增加操作细节
- **INFO**: 用户获取搜索建议、搜索建议创建/更新、频率增加
- **WARNING**: 搜索建议参数不完整、频率更新失败
- **ERROR**: 搜索建议服务不可用、数据库写入异常

#### 2.2.3 热门搜索模块
- **DEBUG**: 热门搜索排序逻辑、搜索计数更新细节
- **INFO**: 热门搜索创建/更新、搜索次数增加、获取热门搜索列表
- **WARNING**: 热门搜索数据不一致、排序规则调整
- **ERROR**: 热门搜索更新失败、缓存同步异常

#### 2.2.4 题目搜索模块
- **DEBUG**: 搜索参数验证、搜索算法执行、结果集处理
- **INFO**: 用户搜索请求、搜索结果统计、搜索时间记录
- **WARNING**: 搜索关键词过长、搜索结果过少、潜在的性能问题
- **ERROR**: 搜索服务调用失败、索引不可用、查询超时

## 3. 日志结构化格式

### 3.1 标准日志字段

```json
{
  "timestamp": "2024-04-25T10:15:30.123456Z",
  "level": "INFO",
  "module": "search.views",
  "function": "search_questions",
  "line": 123,
  "trace_id": "8a7b6c5d4e3f2a1b",
  "user_id": 123,
  "action": "search_questions",
  "status": "success",
  "message": "用户搜索完成",
  "data": {
    "query": "一元一次方程",
    "filters": {"subject": "math", "difficulty": "medium"},
    "results_count": 10,
    "execution_time_ms": 150
  },
  "error": null
}
```

### 3.2 字段说明

| 字段名 | 类型 | 说明 | 必填 |
|-------|------|------|------|
| **timestamp** | string | ISO格式的时间戳 | 是 |
| **level** | string | 日志级别 | 是 |
| **module** | string | 模块名称 | 是 |
| **function** | string | 函数名称 | 是 |
| **line** | integer | 代码行号 | 是 |
| **trace_id** | string | 跟踪ID，用于跨请求追踪 | 是 |
| **user_id** | integer | 用户ID | 否（匿名用户时为空） |
| **action** | string | 操作类型标识 | 是 |
| **status** | string | 操作状态（success/failed） | 是 |
| **message** | string | 日志消息内容 | 是 |
| **data** | object | 附加数据，根据操作类型变化 | 否 |
| **error** | object | 错误信息，包含code和detail | 否（成功时为空） |

### 3.3 错误日志格式

```json
{
  "timestamp": "2024-04-25T10:15:30.123456Z",
  "level": "ERROR",
  "module": "search.views",
  "function": "search_questions",
  "line": 123,
  "trace_id": "8a7b6c5d4e3f2a1b",
  "user_id": 123,
  "action": "search_questions",
  "status": "failed",
  "message": "搜索服务调用失败",
  "data": {
    "query": "一元一次方程",
    "filters": {"subject": "math"}
  },
  "error": {
    "code": "SEARCH_SERVICE_UNAVAILABLE",
    "detail": "搜索服务暂时不可用，请稍后再试",
    "exception": "ConnectionError: Failed to connect to search service"
  }
}
```

## 4. 脱敏规则

### 4.1 敏感信息定义
- **个人身份信息(PII)**: 用户ID、用户名
- **搜索内容**: 搜索关键词、过滤条件
- **系统信息**: IP地址、用户代理

### 4.2 脱敏策略

#### 4.2.1 用户ID脱敏
- 保留用户ID的完整性，但在日志中使用"user_id"字段，避免直接使用用户名
- 示例: `"user_id": 123` 而非 `"username": "zhangsan"`

#### 4.2.2 搜索内容脱敏
- 对于可能包含敏感信息的搜索关键词，在DEBUG级别完整记录，INFO级别及以上进行部分脱敏
- 示例: "一元一次方程求解" → "一元一***求解"

#### 4.2.3 IP地址脱敏
- 对IPv4地址，隐藏最后一部分
- 示例: "192.168.1.100" → "192.168.1.***"
- 对IPv6地址，隐藏后8位

#### 4.2.4 用户代理信息脱敏
- 仅记录浏览器类型和操作系统，移除版本号和其他详细信息
- 示例: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" → "Windows NT 10.0; Win64; x64"

## 5. 日志配置

### 5.1 日志文件路径
```
logs/search/search.log         # 搜索功能主日志
logs/search/error.log          # 错误日志
logs/search/debug.log          # 调试日志
```

### 5.2 日志轮转策略
- 按日期轮转: 每天生成一个新的日志文件
- 文件大小限制: 单个日志文件最大100MB
- 保留周期: 普通日志保留30天，错误日志保留90天

### 5.3 日志记录器配置

```python
# settings.py 日志配置示例
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'json': {
            '()': 'django.utils.log.JSONFormatter',
            'format': ('%(timestamp)s %(levelname)s %(module)s %(funcName)s %(lineno)d ' 
                      '%(trace_id)s %(user_id)s %(action)s %(status)s %(message)s %(data)s %(error)s')
        },
        'verbose': {
            'format': '%(asctime)s [%(levelname)s] %(module)s.%(funcName)s:%(lineno)d - %(message)s'
        }
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.handlers.TimedRotatingFileHandler',
            'filename': os.path.join(BASE_DIR, 'logs', 'search', 'search.log'),
            'when': 'midnight',
            'backupCount': 30,
            'formatter': 'json'
        },
        'error': {
            'level': 'ERROR',
            'class': 'logging.handlers.TimedRotatingFileHandler',
            'filename': os.path.join(BASE_DIR, 'logs', 'search', 'error.log'),
            'when': 'midnight',
            'backupCount': 90,
            'formatter': 'json'
        },
        'debug': {
            'level': 'DEBUG',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': os.path.join(BASE_DIR, 'logs', 'search', 'debug.log'),
            'maxBytes': 104857600,  # 100MB
            'backupCount': 10,
            'formatter': 'json'
        },
        'console': {
            'level': 'INFO',
            'class': 'logging.StreamHandler',
            'formatter': 'verbose'
        }
    },
    'loggers': {
        'search': {
            'handlers': ['file', 'error', 'debug', 'console'],
            'level': 'DEBUG',
            'propagate': False
        }
    }
}
```

## 6. 日志使用指南

### 6.1 日志记录示例

#### 6.1.1 导入日志模块
```python
import logging
from django.utils.decorators import method_decorator
from django.views.decorators.csrf import csrf_exempt

logger = logging.getLogger('search')
```

#### 6.1.2 记录INFO级别日志
```python
def search_questions(request):
    # 获取trace_id
    trace_id = request.headers.get('X-Trace-ID', 'unknown')
    user_id = request.user.id if request.user.is_authenticated else None
    
    # 记录搜索请求
    logger.info(
        '用户搜索请求',
        extra={
            'trace_id': trace_id,
            'user_id': user_id,
            'action': 'search_questions',
            'status': 'started',
            'data': {
                'query': request.GET.get('q', ''),
                'filters': {
                    'subject': request.GET.get('subject'),
                    'difficulty': request.GET.get('difficulty')
                }
            }
        }
    )
    
    try:
        # 搜索逻辑...
        results = Question.objects.filter(content__icontains=query)
        
        # 记录搜索成功
        logger.info(
            '用户搜索完成',
            extra={
                'trace_id': trace_id,
                'user_id': user_id,
                'action': 'search_questions',
                'status': 'success',
                'data': {
                    'query': query,
                    'results_count': len(results),
                    'execution_time_ms': calculate_execution_time()
                }
            }
        )
        
        return Response({'results': results})
    
    except Exception as e:
        # 记录错误
        logger.error(
            '搜索失败',
            extra={
                'trace_id': trace_id,
                'user_id': user_id,
                'action': 'search_questions',
                'status': 'failed',
                'data': {'query': query},
                'error': {
                    'code': 'SEARCH_FAILED',
                    'detail': str(e),
                    'exception': repr(e)
                }
            }
        )
        raise
```

#### 6.1.3 记录WARNING级别日志
```python
def get_search_suggestions(request):
    q = request.GET.get('q', '').strip()
    
    if not q:
        logger.warning(
            '搜索建议请求缺少关键词',
            extra={
                'trace_id': request.headers.get('X-Trace-ID', 'unknown'),
                'user_id': request.user.id if request.user.is_authenticated else None,
                'action': 'get_search_suggestions',
                'status': 'warning',
                'data': {'q': q}
            }
        )
        return Response({'error': '搜索关键词不能为空'}, status=400)
    
    # 正常逻辑...
```

#### 6.1.4 记录DEBUG级别日志
```python
def increment_search_count(popular_search_id):
    try:
        search_obj = PopularSearch.objects.get(id=popular_search_id)
        logger.debug(
            '更新热门搜索计数',
            extra={
                'action': 'increment_search_count',
                'data': {
                    'search_id': popular_search_id,
                    'current_count': search_obj.search_count
                }
            }
        )
        
        search_obj.increment_search_count()
        
        logger.debug(
            '热门搜索计数更新完成',
            extra={
                'action': 'increment_search_count',
                'data': {
                    'search_id': popular_search_id,
                    'new_count': search_obj.search_count
                }
            }
        )
        
        return search_obj.search_count
    except PopularSearch.DoesNotExist:
        logger.error(
            '热门搜索记录不存在',
            extra={
                'action': 'increment_search_count',
                'status': 'failed',
                'error': {
                    'code': 'SEARCH_NOT_FOUND',
                    'detail': f'ID为{popular_search_id}的热门搜索记录不存在'
                }
            }
        )
        raise
```

### 6.2 性能考虑
- 避免记录过大的数据结构，对于大型结果集只记录统计信息
- 对于频繁调用的函数，使用条件日志记录
- 考虑异步日志记录以减少对主业务流程的影响

## 7. 日志分析与监控

### 7.1 关键监控指标
- **搜索成功率**: 成功搜索请求数 / 总搜索请求数
- **平均搜索响应时间**: 所有搜索请求的平均执行时间
- **搜索错误率**: 错误搜索请求数 / 总搜索请求数
- **搜索频率分布**: 不同时间段的搜索请求分布
- **热门搜索词**: 搜索频率最高的关键词

### 7.2 异常监控规则
- 连续3次搜索失败触发告警
- 搜索响应时间超过2秒触发告警
- 短时间内同一用户频繁搜索触发告警

## 8. 安全考虑

### 8.1 日志访问控制
- 日志文件权限设置为640，仅允许特定用户组访问
- 日志查看接口需要管理员权限
- 定期审查日志访问记录

### 8.2 日志安全存储
- 生产环境日志文件加密存储
- 敏感日志信息定期清理
- 日志备份采用加密传输和存储

## 9. 最佳实践

1. **使用结构化日志**：便于自动化分析和处理
2. **保持日志简洁**：只记录必要的信息，避免冗余
3. **统一日志格式**：确保整个系统日志格式一致
4. **使用有意义的消息**：日志消息应清晰描述事件
5. **包含上下文信息**：记录足够的上下文以方便问题排查
6. **定期审查日志**：及时发现潜在问题和安全隐患
7. **日志轮转配置**：避免日志文件过大占用存储空间

## 10. 附录

### 10.1 日志格式验证工具
提供日志格式验证脚本，确保生成的日志符合规范

### 10.2 日志模板
提供常用操作的日志记录模板，便于开发人员快速使用

### 10.3 脱敏函数示例
提供常用敏感信息脱敏函数的实现示例