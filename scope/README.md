# RP2040 100MHz 示波器使用说明

## 硬件连接

### AD9288 ADC连接
- **DB0-DB7**: 连接到 RP2040 GPIO0-GPIO7（8位并行数据）
- **CLK**: 连接到 RP2040 GPIO21（采样时钟）
- **OE**: 接地（使能输出）
- **VDD**: 3.3V供电
- **GND**: 接地

### ST7789显示屏连接
- **SCK**: GPIO10
- **MOSI**: GPIO11
- **RST**: GPIO12
- **DC**: GPIO13
- **CS**: GPIO14
- **BL**: GPIO15

### EH11旋转编码器连接
- **A相**: GPIO18
- **B相**: GPIO19
- **按键**: GPIO20

### 测试信号输出
- **输出引脚**: GPIO2（用于测试信号生成）

## 功能特性

### 1. 波形显示
- 实时显示AD9288采样的波形
- 支持波形缩放（电压缩放）
- 显示网格和中心参考线
- 绿色波形显示

### 2. 旋转编码器控制
- **旋转**: 调节电压缩放比例（0.1x - 10.0x）
- **短按**: 切换暂停/继续状态
- **长按**: 切换电压缩放/时间缩放模式

### 3. 测量功能
- **频率测量**: 自动计算并显示波形频率
- **电压测量**: 显示峰峰值电压（Vpp）
- **实时更新**: 每50ms更新一次测量值

### 4. 触发功能
- 支持触发级别设置
- 支持上升沿/下降沿触发
- 触发线显示（红色）

### 5. 测试信号生成
- 内置测试信号生成器
- 支持正弦波、方波、三角波、锯齿波
- 可调频率和幅度

## 使用方法

### 基本操作

1. **启动示波器**
   ```bash
   python test_lvgl.py
   ```

2. **调节波形缩放**
   - 顺时针旋转编码器：放大波形
   - 逆时针旋转编码器：缩小波形

3. **暂停/继续**
   - 短按编码器按键：暂停波形显示
   - 再次短按：继续波形显示

4. **切换缩放模式**
   - 长按编码器按键：在电压缩放和时间缩放之间切换

### 测试信号使用

在代码中启用测试信号：

```python
my_scope.toggle_test_signal()  # 启用测试信号
my_scope.set_test_signal_frequency(1000)  # 设置1kHz测试信号
```

### 触发设置

```python
my_scope.set_trigger_level(128)  # 设置触发级别（0-255）
my_scope.set_trigger_enabled(True)  # 启用触发
my_scope.toggle_trigger()  # 切换触发状态
```

## 界面说明

### 顶部状态栏
- **Freq**: 显示当前波形频率
- **Vpp**: 显示峰峰值电压
- **Scale**: 显示当前缩放比例

### 波形显示区
- 中心区域显示实时波形
- 绿色线条表示波形
- 红色线条表示触发级别（当触发启用时）

### 底部信息栏
- **Status**: 显示运行状态（Running/Paused）
- **Mode**: 显示当前模式（Voltage Scale/Time Scale）

## 技术参数

### 采样参数
- **最大采样率**: 100MHz
- **采样精度**: 8位
- **缓冲区大小**: 240点

### 显示参数
- **分辨率**: 320×240
- **刷新率**: 20Hz
- **颜色**: RGB565

### 测量范围
- **频率**: 1Hz - 100MHz
- **电压**: 0V - 3.3V（可缩放）

## 代码结构

### 主要文件
- `scope.py`: 示波器主逻辑
- `hal/ad9288.py`: AD9288 ADC驱动
- `hal/st7789.py`: ST7789显示屏驱动
- `hal/encoder.py`: EH11编码器驱动
- `hal/test_signal.py`: 测试信号生成器
- `test_lvgl.py`: 主程序入口

### 关键类

#### Scope类
```python
class Scope:
    def __init__(self, parent, display_driver):
        # 初始化示波器
    
    def process(self):
        # 处理波形采集和显示
    
    def toggle_test_signal(self):
        # 切换测试信号模式
    
    def set_trigger_level(self, level):
        # 设置触发级别
```

#### Adc9288类
```python
class Adc9288:
    def read(self, buf):
        # 单次采样
    
    def start_continuous_sampling(self, buf):
        # 开始持续采样
    
    def set_trigger_level(self, level):
        # 设置触发级别
```

#### TestSignalGenerator类
```python
class TestSignalGenerator:
    def start(self):
        # 开始输出测试信号
    
    def set_frequency(self, frequency):
        # 设置输出频率
    
    def generate_buffer(self, buffer, sample_rate):
        # 生成测试信号缓冲区
```

## 常见问题

### 1. 波形不稳定
- 检查信号源连接
- 调整触发级别
- 降低采样率

### 2. 频率测量不准确
- 确保波形稳定
- 增加采样点数
- 使用触发功能

### 3. 显示屏不显示
- 检查SPI连接
- 确认背光开启
- 检查电源供应

### 4. 编码器无响应
- 检查编码器连接
- 确认引脚配置正确
- 检查上拉电阻

## 性能优化建议

1. **降低刷新率**: 如果CPU占用过高，可以降低刷新率
2. **减小缓冲区**: 减小采样缓冲区大小可以提高响应速度
3. **优化DMA**: 使用环形缓冲区可以提高采样效率
4. **禁用触发**: 不需要触发时可以禁用以提高性能

## 扩展功能

### 添加更多测量功能
- RMS电压
- 占空比
- 上升时间/下降时间

### 添加存储功能
- 波形保存
- 截图功能
- 数据导出

### 添加通信功能
- USB串口通信
- WiFi远程控制
- 数据上传

## 注意事项

1. **电源稳定性**: 确保3.3V电源稳定
2. **信号幅度**: 输入信号幅度不要超过3.3V
3. **时钟质量**: AD9288需要高质量的时钟信号
4. **散热**: 长时间运行注意散热

## 许可证

本项目仅供学习和研究使用。
